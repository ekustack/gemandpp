import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import{getFirestore,collection,addDoc,onSnapshot,getDocs,query,where,orderBy,deleteDoc,doc,updateDoc,increment}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
const e=await fetch("/.netlify/functions/verifyFb"),t=await e.json(),a=initializeApp(t),n=getAuth(a),o=getFirestore(a),i=collection(o,"points");
let c=null;
const u={image:document.querySelector(".re-user-img"),name:document.querySelector(".re-user-name"),pp:document.querySelector(".pp-count"),gm:document.querySelector(".gm-count"),ex:document.querySelector(".c-ex"),ppIcon:document.querySelector(".icon.pp"),gmIcon:document.querySelector(".gem"),getGem:document.querySelector(".gem"),getGift:document.querySelector(".gift"),claimCard:document.querySelector(".gift-claim"),claimGm:document.querySelector(".gm-claim"),uname:document.getElementById("uname"),uem:document.getElementById("uem"),tpp:document.getElementById("tpp"),tgm:document.getElementById("tgm")};
onAuthStateChanged(n,(e=>{if(e){c=e;const t=c.photoURL;t?u.image.style.cssText=`background: url(${t}) no-repeat center; background-size: contain;`:u.image.textContent="U",c.displayName?u.image.textContent=`${c.displayName.slice(0,1)}`:u.image.textContent="U",u.name.textContent=`${c.displayName?c.displayName:`${c.id?"user_"+c.id.slice(0,5):"user_"}`}`,u.uem.value=c.email,u.uname.value=c.displayName,document.getElementById("refURL").value=`https://gemandpp.netlify.app/enter#ref?id=${encodeURIComponent(c.email)}`;const e=document.querySelector(".gift-count");e.innerText=u.claimCard.querySelectorAll(".card").length,u.getGift.addEventListener("click",(e=>{u.claimCard.style.display="block"})),u.gmIcon.addEventListener("click",(e=>{r(9,4),document.querySelector(".pay-for").style.display="block"})),u.claimCard.querySelectorAll(".card button").forEach((e=>{e.onclick=function(){e.style.opacity="50%",e.textContent="CLAIMED",d(1),e.innerText-=1,e.onclick=null,setTimeout((()=>{window.open("https://www.effectivecpmrate.com/uxx2gjrqc?key=76a628bbfc45e55ee2e31d6593b85938")}),300)}}));const t=document.querySelectorAll(".part-par");t.forEach((e=>{const t=e.querySelector(".part-1"),a=e.querySelector(".part-2"),n=e.querySelector(".part-cover");t.addEventListener("click",(e=>{n.style.marginLeft="0",n.style.borderRadius="10px 0 0 10px"})),a.addEventListener("click",(e=>{n.style.marginLeft="45%",n.style.borderRadius="0 10px 10px 0"}));const o=e.querySelectorAll(".pp-get"),i=e.querySelectorAll(".pp-price"),c=e.querySelectorAll(".gm-get"),r=e.querySelectorAll(".gm-price"),s=e.querySelectorAll(".get"),l=e.querySelectorAll(".get-gm"),d=e.querySelector(".buy-gem");s.forEach((e=>{e.addEventListener("click",(e=>{r(+e.parentElement.querySelector(".pp-get").innerText,e.parentElement.querySelector(".pp-price").innerText),document.querySelector(".pay-for").style.display="block"}))})),l.forEach((e=>{e.addEventListener("click",(e=>{r(7*+e.parentElement.querySelector(".gm-get").innerText,e.parentElement.querySelector(".gm-price").innerText),document.querySelector(".pay-for").style.display="block"}))}))})),window.initPoints=async function(){const e=c.email;try{const t=query(i,where("emailAdd","==",e)),a=await getDocs(t);let n;if(a.empty){const e=await addDoc(i,{emailAdd:e,points:5,claimed:!0,createdAt:Date.now()});n={id:e.id,points:5},u.pp.name=n.id?n.id:null}else{const t=a.docs[0];n={id:t.id,...t.data()},u.pp.name=n.id?n.id:null,n.claimed===!1&&(await updateDoc(doc(o,"points",n.id),{points:increment(5),claimed:!0}),n.points=(n.points||0)+5)}u.pp&&(u.pp.textContent=n.points,u.tpp.value=n.points),n.points>=30&&u.gm&&(u.gm.textContent=((n.points-5)/n.points).toFixed(1),u.tgm.value=((n.points-5)/n.points).toFixed(1))}catch(e){}};initPoints()}else window.location.href="/enter.html"})),document.getElementById("log").addEventListener("click",(()=>{signOut(n).then((()=>{window.location.reload()})).catch((e=>{}))})),window.addPoint=async function e(t){const a=doc(o,"points",u.pp.name);await updateDoc(a,{points:increment(t)}),initPoints()};function r(e,t){window.paypal&&document.querySelector("#paypal-button-container")&&paypal.Buttons({createOrder:(e,a)=>{return a.order.create({purchase_units:[{amount:{value:String(t)}}]})},onApprove:async(e,t)=>{const a=await t.order.capture();await addPoint(e),alert(`Thank you, ${a.payer.name.given_name}! You are credited with posting points and can now add your "Learn More" link.`)}}).render("#paypal-button-container")}
