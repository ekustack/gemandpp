import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

import { getFirestore, collection, addDoc, onSnapshot, getDocs, query, where, orderBy, deleteDoc, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const res=await fetch("/.netlify/functions/verifyFb");const config=await res.json();const app = initializeApp(config)
const auth=getAuth(app),db=getFirestore(app),pointCollection=collection(db,"points");let currentUser=null;const userCard={image:document.querySelector(".re-user-img"),name:document.querySelector(".re-user-name"),pp:document.querySelector(".pp-count"),gm:document.querySelector(".gm-count"),ngn:document.querySelector(".ngn"),ex:document.querySelector(".c-ex"),ppIcon:document.querySelector(".icon"),gmIcon:document.querySelector(".gm"),getGem:document.querySelector(".gem"),getGift:document.querySelector(".gift"),claimCard:document.querySelector(".gift-claim"),claimGm:document.querySelector(".gm-claim"),uname:document.getElementById("uname"),uem:document.getElementById("uem"),tpp:document.getElementById("tpp"),tgm:document.getElementById("tgm")};onAuthStateChanged(auth,(e=>{if(e){currentUser=e,console.log(e.displayName);const t=currentUser.photoURL;t?userCard.image.style.cssText=`background: url(${t}) no-repeat center;\nbackground-size: contain;`:userCard.image.textContent="U",currentUser.displayName?userCard.image.textContent=`${currentUser.displayName.slice(0,1)}`:userCard.image.textContent="U",userCard.name.textContent=`${currentUser.displayName?currentUser.displayName:""+(currentUser.id?"user_"+currentUser.id.slice(0,5):"user_")}`;const n=document.querySelector(".gift-count");userCard.uem.value=currentUser.email,userCard.uname.value=currentUser.displayName,document.getElementById("refURL").value=`https://gemandpp.netlify.app/enter#ref?id=${encodeURIComponent(currentUser.email)}`,n.innerText=userCard.claimCard.querySelectorAll(".card").length,userCard.getGift.addEventListener("click",(e=>{userCard.claimCard.style.display="block"})),userCard.gmIcon.addEventListener("click",(e=>{payFor(9,4)})),userCard.claimCard.querySelectorAll(".card button").forEach((e=>{e.onclick=function(){e.style.opacity="50%",e.textContent="CLAIMED",addPoint(1),n.innerText-=1,e.onclick=null,window.open("https://www.revenuecpmgate.com/uxx2gjrqc?key=76a628bbfc45e55ee2e31d6593b85938")}})),window.initPoints=async function(){const e=currentUser.email;try{const t=query(pointCollection,where("emailAdd","==",e)),n=await getDocs(t);let r;if(n.empty){r={id:(await addDoc(pointCollection,{emailAdd:e,points:5,claimed:!0,createdAt:Date.now()})).id,points:5},userCard.pp.name=r.id?r.id:null}else{const e=n.docs[0];if(r={id:e.id,...e.data()},userCard.pp.name=r.id?r.id:null,!1===r.claimed){const e=doc(db,"points",r.id);await updateDoc(e,{points:(r.points||0)+5,claimed:!0}),r.points=(r.points||0)+5}}userCard.pp&&(userCard.pp.textContent=r.points||0,userCard.tpp.value=r.points||0);const o=[15,12,24,17,28,10,26,8,13,20,25,14,6,13,18,27,19,16,7,19],a=o[Math.floor(Math.random()*o.length)],c=(r.points||-30)/a;if(userCard.ngn.textContent=fn(c),r.points>=50&&userCard.gm){let e=(r.points-46)/r.points;e<0&&(e=0),userCard.gm.textContent=e.toFixed(2),userCard.tgm.value=e.toFixed(2)}}catch(e){console.error("Error initializing points:",e)}},initPoints()}else window.location.href="/enter.html"})),document.getElementById("logoutBtn").addEventListener("click",(()=>{signOut(auth).then((()=>{console.log("Logged out successfully"),window.location.reload()})).catch((e=>{console.error("Logout error:",e)}))})),window.addPoint=async function(e){const t=doc(db,"points",userCard.pp.name);await updateDoc(t,{points:increment(e)}),initPoints()},window.payFor=async function(e,t){document.querySelector(".pay-for").style.display="block",document.querySelector("#paypal-button-container").innerHTML=" ";document.querySelector(".pay-for");window.paypal&&document.querySelector("#paypal-button-container")&&paypal.Buttons({createOrder:(e,n)=>n.order.create({purchase_units:[{amount:{value:String(t)}}]}),onApprove:async(t,n)=>{const r=await n.order.capture();await addPoint(e),alert(`Thank you, ${r.payer.name.given_name}! You are credited with posting points and can now add your "Learn More" link.`)}}).render("#paypal-button-container")},window.fn=function(e){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})};const canvas=document.getElementById("wheel"),ctx=canvas.getContext("2d"),spinBtn=document.getElementById("spinBtn"),spinResult=document.getElementById("spinResult"),rewards=[{text:"+5 PP",value:5},{text:"+1 PP",value:1},{text:"-3 PP",value:-3},{text:"Try Again",value:0},{text:"+10 PP",value:10},{text:"-1 PP",value:-1},{text:"-10 PP",value:-10},{text:"+2 PP",value:2},{text:"+9 PP",value:9},{text:"-13 PP",value:-13},{text:"Try Again",value:0},{text:"+25 PP",value:25},{text:"-9 PP",value:-9},{text:"Try Again",value:0},{text:"-7 PP",value:-7},{text:"-16 PP",value:-16},{text:"-12 PP",value:-12},{text:"+4 PP",value:4}];function drawWheel(){const e=2*Math.PI/rewards.length;rewards.forEach(((t,n)=>{ctx.beginPath(),ctx.fillStyle=n%2==0?"#f4a261":"#2a9d8f",ctx.moveTo(150,150),ctx.arc(150,150,150,n*e,(n+1)*e),ctx.fill(),ctx.save(),ctx.fillStyle="#fff",ctx.translate(150,150),ctx.rotate(n*e+e/2),ctx.textAlign="right",ctx.font="16px Arial",ctx.fillText(t.text,140,10),ctx.restore()}))}drawWheel(),spinBtn.addEventListener("click",(()=>{if(userCard.pp.textContent<6)alert("You have insufficient PP to access this feature.\n Continue engaging to earn more pp.");else{let e=0;Math.random();const t=setInterval((()=>{e+=15,canvas.style.transform=`rotate(${e}deg)`}),20);setTimeout((()=>{clearInterval(t);const e=Math.floor(Math.random()*rewards.length),n=rewards[e];0!==n.value&&addPoint(n.value),0==n.value&&window.open("https://www.revenuecpmgate.com/uxx2gjrqc?key=76a628bbfc45e55ee2e31d6593b85938"),spinResult.textContent=`Result: ${n.text}`}),3e3)}})),document.getElementById("withR").addEventListener("submit",(async function(e){e.preventDefault();const t=e.target;if(Number(document.querySelector(".gm-count").textContent)<1||Number(document.querySelector(".pp-count").textContent)<300)document.getElementById("msg").innerHTML='<div style="color:#B00; font-weight:500;">❌ Request blocked. You do not meet the minimum requirements: <ul style="margin:6px 0; padding-left:20px;"><li>4 Referrals</li><li>1 Gem (GM)</li><li>400 Posting Points (PP)</li></ul></div>';else{const e=new FormData(t);try{(await fetch("https://formspree.io/f/xnndzvnl",{method:"POST",body:e,headers:{Accept:"application/json"}})).ok?(document.getElementById("msg").innerText="✅ Sent successfully!",t.reset()):document.getElementById("msg").innerText="❌ Error sending form."}catch(e){document.getElementById("msg").innerText="⚠️ Network error."}}}));
